#global
#    daemon
#    maxconn 256

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
#    option forceclose
#    option httplog
#    option forwardfor
#    option http-server-close
#    option forwardfor header X-Real-IP

{{range services}}
frontend front-{{.Name | toLower}}
    bind *:80
    balance roundrobin
#    timeout connect 5000ms
#    timeout server  5000ms
#    acl branchA path_beg -i /branchA # specify branch name here
#    use_backend branchA if branchA
    default_backend back-{{.Name | toLower}}
#    default_backend BACKEND_myaddress.net:catchall
    
#backend branchA
#    server branchA 127.0.0.1:10001 maxconn 1500
rt}}
 {{end}}{{end}}
backend back-{{.Name | toLower}}
    {{range service .Name}}# ID {{.ID}}
    server {{.Name}}.{{.Port}} {{.Address}}:{{.Port}} check
    {{end}}
{{end}}

# Haproxy admin
listen stats 0.0.0.0:1936
   stats enable
   stats uri /haproxy
   stats realm Haproxy\ Statistics
   stats auth stats:stats

{{range services}}
  ### Name {{.Name}}
  {{range .Tags}}# Tag {{.}}{{end}}
  {{range service .Name}}# ID {{.ID}}
  # Name {{.Name}}
  # Port {{.Port}}
  # Address {{.Address}}
  # Port {{.Po

#!# byTag service "web"
{{range $tag, $services := service "web" | byTag}}{{$tag}}
{{range $services}} server {{.Name}} {{.Address}}:{{.Port}}
{{end}}{{end}}

#!# byTag services
{{range $tag, $services := services | byTag}}{{$tag}}
{{range $services}} 
  ### Name {{.Name}}
  {{range .Tags}}# Tag {{.}}{{end}}
  {{range service .Name}}# ID {{.ID}}
  # Name {{.Name}}
  # Port {{.Port}}
  # Address {{.Address}}
  # Port {{.Port}}
 {{end}}{{end}}{{end}}
 
group byTag $portTag
filter $frontendPort by ^frontend_port:[0-9]*$
$portTag replaceAll "frontend_port:" ""
range $frontendPort
    frontend front_$frontendPort
range $services
acl host_Name hdr(host) -i .Name

range $services
    use_backend back_Name if host_Name

range $services
    backend back_Name
    {{range service .Name}}# ID {{.ID}}
    server {{.Name}}.{{.Port}} {{.Address}}:{{.Port}} check
    {{end}}
