defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Haproxy admin
listen stats 0.0.0.0:1936
   stats enable
   stats uri /haproxy
   stats realm Haproxy\ Statistics
   stats auth stats:stats

#============================
# byTag services

{{range $tag, $services := services | byTag}}
# Any {{$tag}}
{{range $services}} 
  ### Name {{.Name}}
  {{range .Tags}}# Tag {{.}}
  {{end}}
  {{range service .Name}}# ID {{.ID}}
  # Name {{.Name}}
  # Port {{.Port}}
  # Address {{.Address}}
  # Port {{.Port}}
 {{end}}{{end}}{{end}}

#============================
# byTag frontendPort

{{range $frontendPort, $services := services | byTag}}
    {{if ($frontendPort | regexMatch "^frontend_port:[0-9]*$")}}
# Matched {{$frontendPort}}
        {{$frontendPort := $frontendPort | replaceAll "frontend_port:" ""}}
        # Replaced {{$frontendPort}}
#=>        frontend front_{{$frontendPort}}
        {{range $services}}
            {{$basename := .Name | replaceAll "." "_"}}
#=>          acl host_{{$basename}} hdr(host) -i {{.Name}}{{end}}

        {{range $services}}
            {{$basename := .Name | replaceAll "." "_"}}
#=>          use_backend back_{{$basename}} if host_{{$basename}}{{end}}

        {{range $services}}
            {{$basename := .Name | replaceAll "." "_"}}
#=>          backend back_{{$basename}}
            {{range service .Name}}# ID {{.ID}}
#=>                server {{.Name}}.{{.Port}} {{.Address}}:{{.Port}} check
            {{end}}
        {{end}}
    {{end}}
{{end}}