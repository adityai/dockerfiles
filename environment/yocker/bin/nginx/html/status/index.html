<html>
<head>
    <title>docker--gen-dynatable by georgeyord</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/Dynatable/0.3.1/jquery.dynatable.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>

<body>
<h1>Docker status</h1>

<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active">
        <a href="#status" role="tab" data-toggle="tab">Status</a>
    </li>
    <li role="presentation">
        <a href="#ps" role="tab" data-toggle="tab">List containers</a>
    </li>
    <li role="presentation">
        <a href="#logs" role="tab" data-toggle="tab">Logio</a>
    </li>
    <li role="presentation">
        <a href="#cadvisor" role="tab" data-toggle="tab">cAdvisor</a>
    </li>
    <li role="presentation">
        <a href="#" role="tab" data-toggle="tab"><i class="fa fa-refresh bind-reload"></i> reload</a>
    </li>
</ul>

<!-- Tab panes -->
<div class="tab-content" style="margin-top: 20px;">
    <div role="tabpanel" class="tab-pane active" id="status">
        <table class="table table-striped" id="status-table">
            <thead>
            <th>Name</th>
            <th>Hostname</th>
            <th>Status</th>
            <th>Service</th>
            <th>Compose</th>
            <th>Addresses</th>
            <th>Networks</th>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div role="tabpanel" class="tab-pane" id="ps">
        <a class="btn btn-link btn-sm pull-right" href="/ps.txt" target="_blank">Open in new window <i class="fa fa-external-link"></i></a>
        <iframe src="/ps.txt" width="100%" height="100%"></iframe>
    </div>
    <div role="tabpanel" class="tab-pane" id="logs">
        <a class="btn btn-link btn-sm pull-right" href="http://logs.mydocker.co" target="_blank">Open in new window <i class="fa fa-external-link"></i></a>
        <iframe src="https://logs.mydocker.co/" width="100%" height="100%"></iframe>
    </div>
    <div role="tabpanel" class="tab-pane" id="cadvisor">
        <a class="btn btn-link btn-sm pull-right" href="http://cadvisor.mydocker.co" target="_blank">Open in new window <i class="fa fa-external-link"></i></a>
        <iframe src="https://cadvisor.mydocker.co/" width="100%" height="100%"></iframe>
    </div>
</div>

</body>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/Dynatable/0.3.1/jquery.dynatable.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript">//<![CDATA[
$(window).load(function () {
    /*global _ */
    $(document).ready(function () {
        var statusTable = {
            LABEL_MISSING: '-',
            LINE_BREAK: '<br/>',

            fetch: function () {
                $.ajax({
                    url: "/containers.json",
                    dataType: "json",
                    complete: function (response) {
                        var result = statusTable.parseResponse(response);
                        statusTable.render(result.containers);
                    }
                });
            },

            render: function (containers) {
                if (containers) {
                    console.log(containers);
                    $('#status-table').dynatable({
                        dataset: {
                            records: containers
                        }
                    });
                }
            },

            toHTML: function (value) {
                if (_.isArray(value) && !_.isEmpty(value)) {
                    return value.map(JSON.stringify).join(statusTable.LINE_BREAK);
                }
                if (_.isObject(value) && !_.isEmpty(value)) {
                    return JSON.stringify(value);
                }
                return statusTable.LABEL_MISSING;
            },

            parseResponse: function (response) {
                response = JSON.parse(response.responseText);
                var result = {
                    containers: {}
                };
                if (response) {
                    _.each(response, function (values, label) {
                        switch (label) {
                        case "Containers":
                            result.containers = statusTable.parseContainers(values);
                            break;
                        default:
                        }
                    });
                }
                return result;
            },

            parseContainers: function (values) {
                var containers = [];
                if (values) {
                    _.each(values, function (container) {
                        var result = {
                            name: container.Name || statusTable.LABEL_MISSING,
                            hostname: container.Hostname || statusTable.LABEL_MISSING,
                            id: container.ID || statusTable.LABEL_MISSING,
                            status: (container.State && container.State.Running) ?
                                    "Running" :
                                    JSON.stringify(container.State)
                        };
                        result.addresses = statusTable.parseAddresses(container.Addresses);
                        result.networks = statusTable.parseNetworks(container.Networks);
                        result.compose = statusTable.parseCompose(container.Labels);
                        var service = statusTable.parseService(container.Env);
                        result.service = statusTable.LABEL_MISSING;
                        if (service && service.ports) {
                            result.service = service.ports.map(function (port) {
                                var prefix = port == "443" ? "https://" : "http://",
                                        suffix = (port == "80" || port == "443") ? '' : ":" + port,
                                        url = prefix + service.name + suffix,
                                        link = $('<a>').attr('target', '_blank').attr('href', url).html(url);
                                return $('<div>').append(link.clone()).html();
                            }).join(statusTable.LINE_BREAK);
                        }
                        result.addresses = statusTable.toHTML(result.addresses);
                        result.networks = statusTable.toHTML(result.networks);
                        result.compose = statusTable.toHTML(result.compose);
                        containers.push(result);
                    });
                }
                return containers;
            },

            parseAddresses: function (values) {
                var result = [];
                _.each(values, function (value) {
                    result.push({host_ip: value.HostIP, host_port: value.HostPort, port: value.Port});
                });
                return result;
            },

            parseNetworks: function (values) {
                var result = [];
                _.each(values, function (value) {
                    result.push({ip: value.IP, name: value.Name, port: value.Port});
                });
                return result;
            },

            parseService: function (values) {
                var result = {};
                if (values.SERVICE_NAME) {
                    result.name = values.SERVICE_NAME;
                }
                if (values.SERVICE_PORT_MAPPING) {
                    var ports = values.SERVICE_PORT_MAPPING.split(',')
                            .map(function (s) {
                                return (s.indexOf(':') === -1) ? s : s.substring(0, s.indexOf(':'))
                            })
                            .map(function (s) {
                                return (s.indexOf('/') === -1) ? s : s.substring(0, s.indexOf('/'))
                            });
                    result.ports = ports;
                }
                return result;
            },

            parseCompose: function (values) {
                var result = {};
                if (values["com.docker.compose.project"]) {
                    result.project = values["com.docker.compose.project"];
                }
                if (values["com.docker.compose.service"]) {
                    result.service = values["com.docker.compose.service"];
                }
                if (values["com.docker.compose.container-number"]) {
                    result.number = values["com.docker.compose.container-number"];
                }
                return result;
            }
        };

        // Start statusTable
        statusTable.fetch();

        // Activate reloading buttons
        $('.bind-reload').on('click', function (e) {
            e.preventDefault();
            location.reload();
        });
        $('.bind-containers-reload').on('click', function (e) {
            e.preventDefault();
            statusTable.fetch();
        });
    });
});//]]>
</script>
</html>